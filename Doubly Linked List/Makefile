#   make [test] - builds everything, and runs the tests
#   make build  - just builds everything
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.

# Project settings. Change these to match your files

.DEFAULT_GOAL := test
DLL_IMPL = doubly_linked_list
DLL_TEST = dll_tests
CXX = g++
CC = gcc
CFLAGS += -g -Wall -std=c11
CXXFLAGS += -g -Wall -Wextra  -pthread -std=c++17

# ifdef PROFILE
#  CFLAGS += -DDEBUG
#  CXXFLAGS += -DDEBUG
# endif

leak: clean
leak : CFLAGS += -fsanitize=address -ggdb #-fno-omit-frame-pointer
leak: 	CXXFLAGS= -fsanitize=address -ggdb #-fno-omit-frame-pointer
leak: test

# Primary build targets.
test : build
	./$(DLL_TEST)

build: $(DLL_TEST)

clean :
	rm -f gtest_main.a *.o $(DLL_TEST) asan.*

# Targets for building the hash table test suite
$(DLL_IMPL).o : $(DLL_IMPL).c $(DLL_IMPL).h $(GTEST_HEADERS)
	$(CC) $(CFLAGS) -c $(DLL_IMPL).c

$(DLL_TEST).o : $(DLL_TEST).cpp $(DLL_IMPL).h $(GTEST_HEADERS)
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -c $(DLL_TEST).cpp

$(DLL_TEST) : $(DLL_IMPL).o $(DLL_TEST).o gtest_main.a
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) -lpthread $^ -o $@

# Google test framework settings. Don't mess with these!
GTEST_DIR = gtest
GTEST_HEADERS = $(GTEST_DIR)/include/gtest/*.h \
                $(GTEST_DIR)/include/gtest/internal/*.h
GTEST_SRCS_ = $(GTEST_DIR)/src/*.h $(GTEST_HEADERS)
CPPFLAGS += -isystem $(GTEST_DIR)/include

# Targets for building Google Test framework
gtest-all.o : $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) -c \
            $(GTEST_DIR)/src/gtest-all.cc

gtest_main.o : $(GTEST_SRCS_)
	$(CXX) $(CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) -c \
            $(GTEST_DIR)/src/gtest_main.cc

gtest_main.a : gtest-all.o gtest_main.o
	$(AR) $(ARFLAGS) $@ $^
